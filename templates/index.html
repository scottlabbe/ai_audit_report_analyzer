<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Report Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Audit Report Analyzer</h1>
        
        <!-- Loading indicator -->
        <div id="globalLoadingIndicator" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
            <div class="bg-white p-5 rounded-lg flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mr-3"></div>
                <p>Loading... Please wait.</p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Upload PDF Report</h2>
            <form id="uploadForm" class="flex flex-col items-start">
                <div class="flex items-center mb-4">
                    <input type="file" id="pdfFile" accept=".pdf" class="border p-2 mr-4">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload and Analyze</button>
                </div>
                <div class="flex items-center mb-4">
                    <p class="mr-4">Select AI Model:</p>
                    <label class="inline-flex items-center mr-4">
                        <input type="radio" name="ai_model" value="gpt-4" class="form-radio" checked>
                        <span class="ml-2">GPT-4</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="ai_model" value="claude-sonnet" class="form-radio">
                        <span class="ml-2">Claude Sonnet</span>
                    </label>
                </div>
            </form>
        </div>

        <div id="analysisResult" class="hidden bg-white p-6 rounded shadow-md">
            <h2 class="text-xl font-semibold mb-4">Analysis Result</h2>
            <div id="resultContent"></div>
            <button id="downloadMarkdown" class="mt-4 bg-green-500 text-white px-4 py-2 rounded">Download as Markdown</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('uploadForm');
        const analysisResult = document.getElementById('analysisResult');
        const resultContent = document.getElementById('resultContent');
        const loadingIndicator = document.getElementById('globalLoadingIndicator');
        const downloadMarkdownButton = document.getElementById('downloadMarkdown');

        let currentAnalysisResult = null;

        function showLoadingIndicator() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoadingIndicator() {
            loadingIndicator.classList.add('hidden');
        }

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files.length) {
                alert('Please select a file before submitting.');
                return;
            }
            showLoadingIndicator();

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('ai_model', document.querySelector('input[name="ai_model"]:checked').value);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingIndicator();
                if (data.data) {
                    currentAnalysisResult = data.data;
                    displayAnalysis(data.data);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideLoadingIndicator();
                alert('An error occurred during upload and analysis.');
            });
        });

        function displayAnalysis(content) {
            resultContent.innerHTML = `
                <h3 class="font-bold">${content.report_title || 'N/A'}</h3>
                <p><strong>Audit Organization:</strong> ${content.audit_organization || 'N/A'}</p>
                <p><strong>Audit Objectives:</strong> ${(content.audit_objectives || []).join(', ') || 'N/A'}</p>
                <p><strong>Overall Conclusion:</strong> ${content.overall_conclusion || 'N/A'}</p>
                <h4 class="font-semibold mt-4">Key Findings:</h4>
                <ul>${(content.key_findings || []).map(f => `<li>${f}</li>`).join('') || '<li>N/A</li>'}</ul>
                <h4 class="font-semibold mt-4">Recommendations:</h4>
                <ul>${(content.recommendations || []).map(r => `<li>${r}</li>`).join('') || '<li>N/A</li>'}</ul>
                <p><strong>AI-Generated Insight:</strong> ${content.llm_insight || 'N/A'}</p>
                <h4 class="font-semibold mt-4">Potential Future Audit Objectives:</h4>
                <ul>${(content.potential_audit_objectives || []).map(o => `<li>${o}</li>`).join('') || '<li>N/A</li>'}</ul>
            `;
            analysisResult.classList.remove('hidden');
        }

        downloadMarkdownButton.addEventListener('click', function() {
            if (!currentAnalysisResult) {
                alert('No analysis result available. Please upload and analyze a file first.');
                return;
            }

            showLoadingIndicator();

            fetch('/download_markdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentAnalysisResult)
            })
            .then(response => {
                hideLoadingIndicator();
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Network response was not ok.');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${currentAnalysisResult.report_title || 'analysis_result'}.md`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while downloading the markdown file.');
            });
        });
    });
    </script>
</body>
</html>
