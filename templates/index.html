<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Report Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Audit Report Analyzer</h1>
        
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Upload PDF Report</h2>
            <form id="uploadForm" class="flex flex-col items-start">
                <div class="flex items-center mb-4">
                    <input type="file" id="pdfFile" accept=".pdf" class="border p-2 mr-4">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload and Analyze</button>
                </div>
            </form>
            <div id="loadingIndicator" style="display: none;" class="mt-4 flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mr-3"></div>
                <p>Uploading and analyzing... Please wait.</p>
            </div>
        </div>

        <div id="analysisResult" class="hidden bg-white p-6 rounded shadow-md">
            <h2 class="text-xl font-semibold mb-4">Analysis Result</h2>
            <div id="resultContent"></div>
            <button id="exportBtn" class="mt-4 bg-green-500 text-white px-4 py-2 rounded">Export as Markdown</button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4">Previous Reports</h2>
            <ul id="reportsList" class="space-y-2"></ul>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('uploadForm');
        const analysisResult = document.getElementById('analysisResult');
        const resultContent = document.getElementById('resultContent');
        const exportBtn = document.getElementById('exportBtn');
        const reportsList = document.getElementById('reportsList');

        console.log('Full HTML content:', document.documentElement.outerHTML);

        function showLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'flex';
                console.log('Loading indicator shown');
            } else {
                console.error('Loading indicator element not found');
            }
        }

        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
                console.log('Loading indicator hidden');
            }
        }

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submitted, preparing to show loading indicator');
            showLoadingIndicator();

            const formData = new FormData();
            const fileInput = document.getElementById('pdfFile');
            formData.append('file', fileInput.files[0]);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Fetch request completed, hiding loading indicator');
                hideLoadingIndicator();

                if (data.id) {
                    fetchReport(data.id);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                console.log('Error occurred, hiding loading indicator');
                hideLoadingIndicator();
                alert('An error occurred during upload and analysis.');
            });
        });

        function fetchReport(id) {
            fetch(`/report/${id}`)
            .then(response => response.json())
            .then(report => {
                if (report.error) {
                    throw new Error(report.error);
                }
                displayReport(report);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        }

        function displayReport(report) {
            const content = report.content;
            
            if (!content || typeof content !== 'object') {
                resultContent.innerHTML = '<p class="text-red-500">Error: Invalid report data</p>';
                analysisResult.style.display = 'block';
                exportBtn.style.display = 'none';
                return;
            }
            
            resultContent.innerHTML = `
                <h3 class="font-bold">${content.report_title || 'N/A'}</h3>
                <p><strong>Audit Organization:</strong> ${content.audit_organization || 'N/A'}</p>
                <p><strong>Audit Objectives:</strong> ${(content.audit_objectives || []).join(', ') || 'N/A'}</p>
                <p><strong>Overall Conclusion:</strong> ${content.overall_conclusion || 'N/A'}</p>
                <h4 class="font-semibold mt-4">Key Findings:</h4>
                <ul>${(content.key_findings || []).map(f => `<li>${f}</li>`).join('') || '<li>N/A</li>'}</ul>
                <h4 class="font-semibold mt-4">Recommendations:</h4>
                <ul>${(content.recommendations || []).map(r => `<li>${r}</li>`).join('') || '<li>N/A</li>'}</ul>
                <p><strong>AI-Generated Insight:</strong> ${content.llm_insight || 'N/A'}</p>
                <h4 class="font-semibold mt-4">Potential Future Audit Objectives:</h4>
                <ul>${(content.potential_audit_objectives || []).map(o => `<li>${o}</li>`).join('') || '<li>N/A</li>'}</ul>
            `;
            analysisResult.style.display = 'block';
            exportBtn.style.display = 'inline-block';
            exportBtn.onclick = () => window.location.href = `/export/${report.id}`;
        }

        function fetchReports() {
            fetch('/reports')
            .then(response => response.json())
            .then(reports => {
                reportsList.innerHTML = reports.map(report => `
                    <li>
                        <a href="#" class="text-blue-500 hover:underline" onclick="fetchReport(${report.id}); return false;">
                            ${report.file_name} (Version ${report.version})
                        </a>
                    </li>
                `).join('');
            })
            .catch(error => console.error('Error:', error));
        }

        fetchReports();
    });
    </script>
</body>
</html>
