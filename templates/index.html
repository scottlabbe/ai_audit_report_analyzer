<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Report Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Audit Report Analyzer</h1>
        
        <!-- Loading indicator -->
        <div id="globalLoadingIndicator" class="hidden fixed top-0 left-0 w-full h-full flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
            <div class="bg-white p-5 rounded-lg flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mr-3"></div>
                <p>Loading... Please wait.</p>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Upload PDF Report</h2>
            <form id="uploadForm" class="flex flex-col items-start">
                <div class="flex items-center mb-4">
                    <input type="file" id="pdfFile" accept=".pdf" class="border p-2 mr-4">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload and Analyze</button>
                </div>
                <div class="flex items-center mb-4">
                    <p class="mr-4">Select AI Model:</p>
                    <label class="inline-flex items-center mr-4">
                        <input type="radio" name="ai_model" value="gpt-4o-mini" class="form-radio" checked>
                        <span class="ml-2">GPT-4o-mini</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="ai_model" value="claude-sonnet" class="form-radio">
                        <span class="ml-2">Claude Sonnet 3.5</span>
                    </label>
                </div>
            </form>
        </div>

        <div id="analysisResult" class="hidden bg-white p-6 rounded shadow-md">
            <h2 class="text-xl font-semibold mb-4">Analysis Result</h2>
            <div id="resultContent"></div>
            <button id="exportBtn" class="hidden mt-4 bg-green-500 text-white px-4 py-2 rounded">Export as Markdown</button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold mb-4">Previous Reports</h2>
            <ul id="reportsList" class="space-y-2"></ul>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('uploadForm');
        const analysisResult = document.getElementById('analysisResult');
        const resultContent = document.getElementById('resultContent');
        const exportBtn = document.getElementById('exportBtn');
        const reportsList = document.getElementById('reportsList');
        const loadingIndicator = document.getElementById('globalLoadingIndicator');

        console.log('Loading indicator element:', loadingIndicator);

        function showLoadingIndicator() {
            if (loadingIndicator) {
                loadingIndicator.style.display = 'flex';
                console.log('Loading indicator shown');
            } else {
                console.error('Loading indicator element not found');
            }
        }

        function hideLoadingIndicator() {
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
                console.log('Loading indicator hidden');
            }
        }

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files.length) {
                alert('Please select a file before submitting.');
                return;
            }
            console.log('Form submitted, preparing to show loading indicator');
            showLoadingIndicator();

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('ai_model', document.querySelector('input[name="ai_model"]:checked').value);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Fetch request completed, hiding loading indicator');
                hideLoadingIndicator();

                if (data.id) {
                    console.log('Report uploaded successfully, fetching report with ID:', data.id);
                    fetchReport(data.id);
                    fetchReports();
                } else {
                    console.error('Error in upload response:', data.error);
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                console.log('Error occurred, hiding loading indicator');
                hideLoadingIndicator();
                alert('An error occurred during upload and analysis.');
            });
        });

        function fetchReport(id) {
            console.log('Fetching report with ID:', id);
            fetch(`/report/${id}`)
            .then(response => response.json())
            .then(report => {
                console.log('Received report data:', report);
                if (report.error) {
                    throw new Error(report.error);
                }
                displayReport(report);
            })
            .catch(error => {
                console.error('Error fetching report:', error);
                alert('Error: ' + error.message);
            });
        }

        function displayReport(report) {
            console.log('Displaying report:', report);
            console.log('Full report object:', JSON.stringify(report, null, 2));
            
            const content = report.content;
            console.log('Content object:', JSON.stringify(content, null, 2));
            
            if (!content || typeof content !== 'object') {
                console.error('Invalid report data:', content);
                resultContent.innerHTML = '<p class="text-red-500">Error: Invalid report data</p>';
                analysisResult.style.display = 'block';
                exportBtn.style.display = 'none';
                return;
            }
            
            let htmlContent = `
                <h3 class="font-bold">${content.report_title || 'N/A'}</h3>
                <p><strong>Audit Organization:</strong> ${content.audit_organization || 'N/A'}</p>
                <p><strong>Audit Objectives:</strong> ${(content.audit_objectives || []).join(', ') || 'N/A'}</p>
                <p><strong>Overall Conclusion:</strong> ${content.overall_conclusion || 'N/A'}</p>
                <h4 class="font-semibold mt-4">Key Findings:</h4>
                <ul>${(content.key_findings || []).map(f => `<li>${f}</li>`).join('') || '<li>N/A</li>'}</ul>
                <h4 class="font-semibold mt-4">Recommendations:</h4>
                <ul>${(content.recommendations || []).map(r => `<li>${r}</li>`).join('') || '<li>N/A</li>'}</ul>
                <p><strong>AI-Generated Insight:</strong> ${content.llm_insight || 'N/A'}</p>
                <h4 class="font-semibold mt-4">Potential Future Audit Objectives:</h4>
                <ul>${(content.potential_audit_objectives || []).map(o => `<li>${o}</li>`).join('') || '<li>N/A</li>'}</ul>
            `;
            
            console.log('Generated HTML content:', htmlContent);
            resultContent.innerHTML = htmlContent;
            analysisResult.style.display = 'block';
            exportBtn.style.display = 'inline-block';
            exportBtn.onclick = () => window.location.href = `/export/${report.id}`;
            
            console.log('Report displayed successfully');
        }

        function fetchReports() {
            fetch('/reports')
            .then(response => response.json())
            .then(reports => {
                console.log('Fetched reports:', reports);
                reportsList.innerHTML = reports.map(report => `
                    <li class="flex items-center justify-between">
                        <a href="#" class="text-blue-500 hover:underline" onclick="fetchReport(${report.id}); return false;">
                            ${report.file_name} (Version ${report.version})
                        </a>
                        <button class="bg-red-500 text-white px-2 py-1 rounded text-sm" onclick="deleteReport(${report.id})">Delete</button>
                    </li>
                `).join('');
            })
            .catch(error => console.error('Error fetching reports:', error));
        }

        window.deleteReport = function(id) {
            if (confirm('Are you sure you want to delete this report?')) {
                showLoadingIndicator();
                fetch(`/delete/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        hideLoadingIndicator();
                        if (data.message) {
                            alert(data.message);
                            fetchReports();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        hideLoadingIndicator();
                        console.error('Error:', error);
                        alert('An error occurred while deleting the report.');
                    });
            }
        }

        window.fetchReport = fetchReport;
        fetchReports();
    });
    </script>
</body>
</html>
